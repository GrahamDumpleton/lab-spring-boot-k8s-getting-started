doctype html
html
    head
        meta(charset="utf-8")
        meta(http-equiv="X-UA-Compatible", content="IE=edge")
        meta(name="viewport", content="width=device-width, initial-scale=1")
        link(rel="apple-touch-icon", sizes="180x180", href="../static/apple-touch-icon.png")
        link(rel="icon", type="image/png", sizes="32x32", href="../static/favicon-32x32.png")
        link(rel="icon", type="image/png", sizes="16x16", href="../static/favicon-16x16.png")
        link(rel="manifest", href="../static/site.webmanifest")
        script(src="../static/js/jquery.min.js")
        script(src="../static/js/popper.min.js")
        script(src="../static/js/bootstrap.min.js")
        script(src="../static/js/require.min.js")
        link(rel='stylesheet', href="../static/css/bootstrap.min.css")
        link(rel='stylesheet', href="../fontawesome/css/all.min.css")

        style.
            html, body {
                height: 100%;
                margin: 0;
                overflow: hidden;
            }
            body {
                padding: 6px;
            }
            .split {
                -webkit-box-sizing: border-box;
                   -moz-box-sizing: border-box;
                        box-sizing: border-box;
                overflow-y: auto;
                overflow-x: hidden;
            }
            .gutter {
                background-color: transparent;
                background-repeat: no-repeat;
                background-position: 50%;
            }
            .gutter.gutter-horizontal {
                cursor: col-resize;
                background-image: url('../static/img/vertical.png');
              }
            .gutter.gutter-vertical {
                cursor: row-resize;
                background-image: url('../static/img/horizontal.png');
            }
            .split.split-horizontal, .gutter.gutter-horizontal {
                height: 100%;
                float: left
            }
            .pane-content {
                height: 100%;
                margin: 0;
                overflow: hidden;
            }

            .btn-transparent {
                background: none;
            }

            .btn:focus,.btn:active {
               outline: none !important;
               box-shadow: none;
            }

            #cover {
                position: fixed;
                height: 100%;
                width: 100%;
                top: 0;
                left: 0;
                background: #007bff;
                z-index: 9999;
                background-position: left bottom;
                background-repeat: no-repeat;
                background-size: auto 40%;
            }

            #cover-message {
                position: absolute;
                left: 20px;
                bottom: 20px;
            }

            .lds-roller {
              display: inline-block;
              position: relative;
              width: 80px;
              height: 80px;
              left: calc(50vw - 40px);
              top: calc(50vh - 40px);
            }
            .lds-roller div {
              animation: lds-roller 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
              transform-origin: 40px 40px;
            }
            .lds-roller div:after {
              content: " ";
              display: block;
              position: absolute;
              width: 7px;
              height: 7px;
              border-radius: 50%;
              background: #fff;
              margin: -4px 0 0 -4px;
            }
            .lds-roller div:nth-child(1) {
              animation-delay: -0.036s;
            }
            .lds-roller div:nth-child(1):after {
              top: 63px;
              left: 63px;
            }
            .lds-roller div:nth-child(2) {
              animation-delay: -0.072s;
            }
            .lds-roller div:nth-child(2):after {
              top: 68px;
              left: 56px;
            }
            .lds-roller div:nth-child(3) {
              animation-delay: -0.108s;
            }
            .lds-roller div:nth-child(3):after {
              top: 71px;
              left: 48px;
            }
            .lds-roller div:nth-child(4) {
              animation-delay: -0.144s;
            }
            .lds-roller div:nth-child(4):after {
              top: 72px;
              left: 40px;
            }
            .lds-roller div:nth-child(5) {
              animation-delay: -0.18s;
            }
            .lds-roller div:nth-child(5):after {
              top: 71px;
              left: 32px;
            }
            .lds-roller div:nth-child(6) {
              animation-delay: -0.216s;
            }
            .lds-roller div:nth-child(6):after {
              top: 68px;
              left: 24px;
            }
            .lds-roller div:nth-child(7) {
              animation-delay: -0.252s;
            }
            .lds-roller div:nth-child(7):after {
              top: 63px;
              left: 17px;
            }
            .lds-roller div:nth-child(8) {
              animation-delay: -0.288s;
            }
            .lds-roller div:nth-child(8):after {
              top: 56px;
              left: 12px;
            }
            @keyframes lds-roller {
              0% {
                transform: rotate(0deg);
              }
              100% {
                transform: rotate(360deg);
              }
            }

            .iframe-div {
              width: 100%;
              height: 100%;
              padding: 0;
              overflow: hidden;
              -webkit-overflow-scrolling: touch;
            }

            .iframe-div iframe {
              width: 100%;
              height: 100%;
              border: 0;
            }

            #workshop-dialog {
                width: auto;
                max-width: 90%;
            }

            .homeroom-link {
                text-align: center;
            }

            .workshop-link {
                text-align: center;
            }

            .slides-link {
                text-align: center;
            }

            .modal-wide {
                min-width: 30%;
                max-width: 95%;
            }

            .modal-body.image-zoom-body {
                text-align: center
            }

            div#workarea-navbar-div {
                border-bottom: 1px solid #eee;
            }

            li.nav-item>a {
                padding-top: 4px;
                padding-bottom: 5px;
            }

            #console-pane: {
                width: 100% !important;
            }

            #slides-pane: {
                width: 100% !important;
            }

            #terminals-pane: {
                width: 100% !important;
            }

            #workshop-pane: {
                width: 100% !important;
            }

            .panel-link {
                text-align: center;
            }

            .panel-div: {
                width: 100% !important;
            }

        script.
            require.config({
              paths: {
                "split": "../static/js/split.min"
              }
            });

            var remoteControlUrl = "#{remoteControlUrl}";

            var terminal_session_counter = 100;

            function generate_terminal_session_id() {
                return terminal_session_counter++;
            }

            function send_to_editor() {
                var editor_tab = document.getElementById("editor-tab");
                $(editor_tab).trigger("click");
                var editorDiv = document.getElementById("editor-div");
                var editor_iframe = $(editorDiv).find("iframe")[0];
                console.log("Remote control url: " + remoteControlUrl);

                $.get(remoteControlUrl + "/hello");
                $.get("/remote-control-editor");
                //- editor_iframe.contentWindow.document.focus();
            }

            function send_to_terminal(value, terminal="1") {
                $("#terminals-tab").trigger("click");
                var name = "terminal" + terminal + "-iframe";
                var terminal_iframe = document.getElementById(name);
                terminal_iframe.contentWindow.butterfly.focus();
                terminal_iframe.contentWindow.butterfly.nativeScrollTo();
                if (value.toLowerCase() == '<ctrl-c>' ||
                        value.toLowerCase() == '<ctrl+c>') {
                    value = String.fromCharCode(0x03);
                    terminal_iframe.contentWindow.butterfly.send(value);
                }
                else {
                    terminal_iframe.contentWindow.butterfly.send(value + '\n');
                }
            }

            function vsplit_double_click() {
                if (window.dashboard.getSizes()[0] < 5.0) {
                    reload_workshop();
                }
                else {
                    hide_workshop();
                }
            }

            function hide_cover() {
                $("#cover").hide();
            }

            function hide_workshop() {
                window.dashboard.collapse(0);
            }

            function load_dashboard(name) {
                var iframe = $(name + " iframe");
                if (iframe && iframe.data("src")) {
                    iframe.prop("src", iframe.data("src"));
                    iframe.data("src", "");
                }
            }

            function reload_dashboard(event) {
                if (event.shiftKey) {
                    reload_workshop();
                }
                else {
                    var active = $('#workarea-div li a.active');

                    if (active) {
                        if (active.attr("id") == "terminals-tab") {
                            reload_terminal();
                        }
                        else {
                            var href = active.attr("href");

                            if (href) {
                                var iframe = $(href + " iframe");
                                if (iframe) {
                                    iframe.attr("src", iframe.attr("src"));
                                }
                            }
                        }
                    }
                }
            }

            function reload_workshop() {
                if (window.dashboard.getSizes()[0] < 5.0) {
                    window.dashboard.setSizes([35, 65]);
                }
                else {
                    var workshop_iframe = $("#workshop-iframe")

                    if (workshop_iframe) {
                        workshop_iframe.contents().get(0).location.reload();
                    }
                }
            }

            function reload_terminal() {
                function execute_reload() {
                    var terminal1_iframe = $("#terminal1-iframe");
                    var terminal2_iframe = $("#terminal2-iframe");
                    var terminal3_iframe = $("#terminal3-iframe");

                    if (terminal1_iframe.get(0)) {
                        terminal1_iframe.contents().get(0).location.reload();
                    }
                    if (terminal2_iframe.get(0)) {
                        terminal2_iframe.contents().get(0).location.reload();
                    }
                    if (terminal3_iframe.get(0)) {
                        terminal3_iframe.contents().get(0).location.reload();
                    }
                }

                var terminal_tab = $('#terminals-tab');

                if (terminal_tab.hasClass('active')) {
                    execute_reload();
                }
                else {
                    terminal_tab.on('shown.bs.tab', function(e){
                        $(e.currentTarget).off('shown.bs.tab');
                        execute_reload();
                    });

                    terminal_tab.trigger("click");
                }
            }

            function open_link_in_console(url) {
                $("#console-iframe").attr('src', url);
                $("#console-tab").trigger("click");
            }

            function open_link_in_slides(url) {
                $("#slides-iframe").attr('src', url);
                $("#slides-tab").trigger("click");
            }

            function bring_terminal_to_front() {
                $("#terminals-tab").trigger("click");
                var terminal_iframe = document.getElementById("terminal1-iframe");
                terminal_iframe.contentWindow.butterfly.focus();
            }

            function finished_workshop_dialog() {
                $("#finished-workshop").modal();
            }

            function open_image_zoom_popup(src, title) {
                $('#image-zoom')[0].src = src;
                $('#image-zoom-title')[0].innerHTML = title;
                $('#image-zoom-popup').modal('show');
            }

            function adjust_split_panes() {
                var height, width;

                height = $("#workshop-div").height();

                $("#workshop-pane").height(height);

                width = $("#workshop-div").width();

                // $("#workshop-pane").width(width);

                height = $("#workarea-div").height();

                height = height - $("#workarea-nav").height();

                $("#terminals-pane").height(height);
                $("#console-pane").height(height);
                $("#slides-pane").height(height);

                $(".panel-div").each(function() {
                    $(this).height(height);
                });

                width = $("#workarea-div").width();

                // $("#terminals-pane").width(width);
                // $("#console-pane").width(width);
                // $("#slides-pane").width(width);
            }

            function adjust_vsplit_panes() {
                var sizes = window.dashboard.getSizes();

                if (sizes[0]/(sizes[0]+sizes[1]) < 0.10) {
                    window.dashboard.collapse(0);
                }
                else {
                    adjust_split_panes();
                }
            }

            function extend_session() {
                $.ajax({
                    type: 'GET',
                    url: "../session/extend",
                    cache: false,
                    success: function(data, textStatus, xhr) {
                        if (data.expires) {
                            var now = new Date();
                            var countdown = Math.floor(data.countdown);
                            window.session_expires = new Date(now.setSeconds(now.getSeconds()+countdown));
                        }
                    },
                    error: function() {}
                });
            }

            $(window).on('load', function() {
                adjust_split_panes();

                $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                    var target = $(e.target).attr('href')
                    if (target == '#terminals-pane') {
                        if ($('#terminal1-iframe')[0]) {
                            $('#terminal1-iframe')[0].contentWindow.butterfly.nativeScrollTo();
                        }
                        if ($('#terminal2-iframe')[0]) {
                            $('#terminal2-iframe')[0].contentWindow.butterfly.nativeScrollTo();
                        }
                        if ($('#terminal3-iframe')[0]) {
                            $('#terminal3-iframe')[0].contentWindow.butterfly.nativeScrollTo();
                        }
                    }
                });

                var dashboard_url = $(location).attr("href");
                $('#workshop-link').append(dashboard_url);

                $("#cover").hide();
            });

    body(onresize="adjust_split_panes()")
        div#cover
            div
                button.close.text-white#cover-close(type="button" aria-label="Close" onclick=`hide_cover();`)
                    span(aria-hidden="true") &times;
            div.lds-roller
                div
                div
                div
                div
                div
                div
                div
                div
            div.text-white#cover-message
                h5 Waiting for environment...

        div.modal.fade#restart-confirmation(tabindex="-1", role="dialog", aria-labelledby="restart-confirmation-title", aria-hidden="true")
            div.modal-dialog.modal-dialog-centered(role="document")
                div.modal-content
                    div.modal-header
                        h5.modal-title#restart-confirmation-title Restart Session
                        button.close(type="button", data-dismiss="modal", aria-label="Close")
                            span(aria-hidden="true") &times;
                    div.modal-body
                        p Restarting the workshop session can result in the loss of progress and/or data. Are you sure?
                    div.modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") Cancel
                        button.btn.btn-primary(type="submit", onclick=`window.top.location.href='${restart_url}';`) Restart

        div.modal.fade#finished-workshop(tabindex="-1", role="dialog", aria-labelledby="finished-workshop-title", aria-hidden="true")
            div.modal-dialog.modal-dialog-centered(role="document")
                div.modal-content
                    div.modal-header
                        h5.modal-title#finished-workshop-title Finish Workshop
                        button.close(type="button", data-dismiss="modal", aria-label="Close")
                            span(aria-hidden="true") &times;
                    div.modal-body
                        if finished_msg
                            p #{finished_msg}
                        else
                            p You have finished the workshop. Restart to begin again.
                    div.modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") Cancel
                        button.btn.btn-primary(type="submit", onclick=`window.top.location.href='${restart_url}';`) Restart

        div.modal.fade#image-zoom-popup(tabindex="-1", role="dialog", aria-labelledby="image-zoom-title", aria-hidden="true")
            div.modal-dialog.modal-dialog-centered.modal-wide(role="document")
                div.modal-content
                    div.modal-header
                        h5.modal-title#image-zoom-title Image
                        button.close(type="button", data-dismiss="modal", aria-label="Close")
                            span(aria-hidden="true") &times;
                    div.modal-body.image-zoom-body
                        image.img-fluid#image-zoom
                    div.modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") Close

        div.modal.fade#workshop-links(tabindex="-1", role="dialog", aria-labelledby="workshop-links-title", aria-hidden="true")
            div.modal-dialog#workshop-dialog(role="document")
                div.modal-content
                    div.modal-header
                        h5.modal-title#workshop-links-title Workshop Links
                        button.close(type="button", data-dismiss="modal", aria-label="Close")
                            span(aria-hidden="true") &times;
                    div.modal-body
                        div.jumbotron.jumbotron-fluid
                            div.container
                                if homeroom_link
                                    h4.homeroom-link
                                        span.badge.badge-secondary Homeroom
                                        | &nbsp;&nbsp;
                                        | #{homeroom_link}
                                else
                                    if workshop_link
                                        h4.workshop-link
                                            span.badge.badge-secondary Workshop
                                            | &nbsp;&nbsp;
                                            | #{workshop_link}
                                    else
                                        h4.workshop-link#workshop-link
                                            span.badge.badge-secondary Workshop
                                            | &nbsp;&nbsp;
                                if slides_link
                                    p
                                    h4.slides-link
                                        span.badge.badge-secondary Slides
                                        | &nbsp;&nbsp;
                                        | #{slides_link}

                                each panel in dashboard_panels
                                    if panel.name && panel.url
                                        p
                                        h4.panel-link
                                            span.badge.badge-secondary #{panel.name}
                                            | &nbsp;&nbsp;
                                            | #{panel.url}

                    div.modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") Dismiss

        div.split.split-horizontal.pane-content.iframe-div#workshop-div
            div#workshop-pane
                iframe#workshop-iframe(src="../workshop/.redirect-when-workshop-is-ready")

        div.split.split-horizontal.pane-content#workarea-div
            div.navbar-content#workarea-navbar-div
                ul.nav.nav-pills.mb-1#workarea-nav(role="tablist")
                    if with_terminal
                        li.nav-item
                            a.nav-link.active#terminals-tab(data-toggle="tab" href="#terminals-pane" role="tab" aria-controls="terminals-pane" aria-selected=true) Terminal

                    if with_console && console_url
                        li.nav-item
                            a.nav-link#console-tab(data-toggle="tab" href="#console-pane" role="tab" aria-controls="console-pane" aria-selected=false) Console

                    if with_slides
                        li.nav-item
                            a.nav-link#slides-tab(data-toggle="tab" href="#slides-pane" role="tab" aria-controls="slides-pane" aria-selected=false) Slides

                    each panel in dashboard_panels
                        if panel.name && panel.url
                            li.nav-item
                                a.nav-link(id=panel.id+"-tab" data-toggle="tab" href="#"+panel.id+"-div" role="tab" aria-controls=panel.id+"-div" aria-selected=false onclick=`load_dashboard("#${panel.id}-div");`) #{panel.name}

                    li.nav-item.ml-auto
                        if with_countdown
                            span.countdown
                                button.btn.btn-default.btn-transparent.fa.fa-stopwatch.d-none.mr-1#countdown-button(type="button" onclick=`extend_session();`)
                        span.refresh
                            button.btn.btn-default.btn-transparent.fa.fa-sync-alt#refresh-button(type="button" onclick=`reload_dashboard(event);`)
                        span.dropdown
                            button.btn.btn-default.btn-transparent.fa.fa-bars#actions-dropdown(type="button", data-toggle="dropdown", aria-haspopup="true", aria-expanded="true")
                            ul.dropdown-menu.dropdown-menu-right(role="menu", aria-labelledby="actions-dropdown")
                                if homeroom_link || workshop_link || slides_link
                                    li.dropdown-item
                                        a(role="menuitem", data-toggle="modal", data-target="#workshop-links") Workshop Links
                                    li.dropdown-divider(role="separator")

                                li.dropdown-item
                                    a(role="menuitem" onclick=`window.open("../workshop");`) Open Workshop

                                if with_terminal
                                    li.dropdown-item
                                        a(role="menuitem" onclick=`window.open("../terminal/session/"+generate_terminal_session_id());`) Open Terminal

                                if with_console && console_url
                                    li.dropdown-item
                                        a(role="menuitem" onclick=`window.open("${console_url}");`) Open Console
                                if with_slides
                                    li.dropdown-item
                                        a(role="menuitem" onclick=`window.open("../slides");`) Open Slides
                                if restart_url
                                    li.dropdown-divider(role="separator")
                                    li.dropdown-item
                                        a(role="menuitem", data-toggle="modal", data-target="#restart-confirmation") Restart Session

            div.tab-content
                if with_terminal
                    div.tab-pane.fade.show.active#terminals-pane(role="tabpanel" aria-labelledby="terminals-tab")
                        div.split.iframe-div#terminal1-div
                            iframe#terminal1-iframe(src="../terminal/session/1")
                        if terminal_layout == 'split'
                            div.split.iframe-div#terminal2-div
                                iframe#terminal2-iframe(src="../terminal/session/2")
                        if terminal_layout == 'split/2'
                            div.split.iframe-div#terminal2-div
                                iframe#terminal2-iframe(src="../terminal/session/2")
                            div.split.iframe-div#terminal3-div
                                iframe#terminal3-iframe(src="../terminal/session/3")

                if with_console && console_url
                    div.tab-pane.fade.show.iframe-div#console-pane(role="tabpanel" aria-labelledby="console-tab")
                        iframe#console-iframe(src=console_url)

                if with_slides
                    div.tab-pane.fade.show.iframe-div#slides-pane(role="tabpanel" aria-labelledby="slides-tab")
                        iframe#slides-iframe(src="../slides/index.html")

                each panel in dashboard_panels
                    if panel.name && panel.url
                        div.tab-pane.fade.show.iframe-div(id=panel.id+"-div" role="tabpanel" aria-labelledby=panel.id+"-tab")
                            div.panel-div
                                iframe(src="about:blank" data-src=panel.url)

        script.
            require(['split'], function(split) {
                window.dashboard = split(['#workshop-div', '#workarea-div'], {
                    gutterSize: 8,
                    sizes: [35, 65],
                    cursor: 'row-resize',
                    snapOffset: 200,
                    minSize: 0,
                    onDrag: function () {
                        adjust_split_panes();
                    }
                });

                $('#workshop-div').next('div.gutter-horizontal').dblclick(vsplit_double_click);
            });

        if terminal_layout == 'split'
            script.
                require(['split'], function(split) {
                    split(['#terminal1-div', '#terminal2-div'], {
                        gutterSize: 8,
                        sizes: [60, 40],
                        direction: 'vertical',
                        onDrag: function () {
                            adjust_split_panes();
                        }
                    });
                });

        if terminal_layout == 'split/2'
            script.
                require(['split'], function(split) {
                    split(['#terminal1-div', '#terminal2-div', '#terminal3-div'], {
                        gutterSize: 8,
                        sizes: [50, 25, 25],
                        direction: 'vertical',
                        onDrag: function () {
                            adjust_split_panes();
                        }
                    });
                });

        script.
            $('#terminal1-iframe').on('load', function() {
                var style = '<style>a { pointer-events: none }</style>';
                $(this).contents().find('head').append(style);
            });

            $('#terminal2-iframe').on('load', function() {
                var style = '<style>a { pointer-events: none }</style>';
                $(this).contents().find('head').append(style);
            });

            $('#terminal3-iframe').on('load', function() {
                var style = '<style>a { pointer-events: none }</style>';
                $(this).contents().find('head').append(style);
            });

            $($('#workarea-nav>li>a')[0]).trigger("click");

            function check_terminals() {
                var dead = $("#terminals-pane iframe").contents().find('body.dead');

                var button = $("#refresh-button")

                if (button) {
                    if (dead.length) {
                        button.addClass("btn-danger");
                        button.removeClass("btn-default");
                        button.removeClass("btn-transparent");
                    }
                    else {
                        button.addClass("btn-default");
                        button.addClass("btn-transparent");
                        button.removeClass("btn-danger");
                    }
                }

                setTimeout(check_terminals, 2500);
            }

            setTimeout(check_terminals, 2500);

            function check_countdown() {
                if (window.session_expires !== undefined) {
                    var now = new Date();
                    var countdown = Math.floor(window.session_expires - now);
                    countdown = Math.max(0, Math.floor(countdown/1000));

                    function format_time(num) {
                        if (num < 10) {
                            var s = "0" + num;
                            return s.substr(s.length-2);
                        }
                        else {
                            return num.toString();
                        }
                    }

                    var text = ' ';
                    text = text + format_time(Math.floor(countdown/60));
                    text = text + ':' + format_time(countdown%60);

                    button = $("#countdown-button");

                    button.removeClass('d-none');
                    button.html(text);

                    if (countdown <= 300) {
                        button.addClass("btn-danger");
                        button.removeClass("btn-default");
                        button.removeClass("btn-transparent");
                    }
                    else {
                        button.addClass("btn-default");
                        button.addClass("btn-transparent");
                        button.removeClass("btn-danger");
                    }
                }
                else {
                    button = $("#countdown-button");

                    button.addClass('d-none');
                    button.html('');
                }

                var update = false;

                if (window.session_expires === undefined) {
                    update = true;
                }
                else {
                    var now = new Date();
                    var countdown = Math.floor(window.session_expires - now);
                    countdown = Math.max(0, Math.floor(countdown/1000));

                    if (countdown && !(countdown % 15)) {
                        update = true;
                    }
                }

                if (update) {
                    $.ajax({
                        type: 'GET',
                        url: "../session/schedule",
                        cache: false,
                        success: function(data, textStatus, xhr) {
                            if (data.expires) {
                                var now = new Date();
                                var countdown = Math.floor(data.countdown);
                                window.session_expires = new Date(now.setSeconds(now.getSeconds()+countdown));
                            }

                            setTimeout(check_countdown, 250);
                        },
                        error: function() {
                            setTimeout(check_countdown, 250);
                        }
                    });
                }
                else {
                    setTimeout(check_countdown, 250);
                }
            }

            if ($("#countdown-button").length) {
                setTimeout(check_countdown, 250);
            }